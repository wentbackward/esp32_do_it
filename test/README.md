# Trackpad Gesture Tests

Comprehensive unit and integration tests for the trackpad gesture processing logic.

## Test Coverage

### Pure Function Tests (Framework-Independent)
- ✅ Clamping utilities
- ✅ Zone detection (main, scroll zones, corners, boundaries)
- ✅ Jitter filtering and dead zone
- ✅ EWMA velocity smoothing
- ✅ Dual-phase acceleration curve (precision/transition/max zones)
- ✅ Tap classification (duration, movement, jitter detection)

### Gesture Sequence Tests
- ✅ Simple tap → click
- ✅ Movement → accelerated cursor movement
- ✅ Tap-tap-drag → drag with button held
- ✅ Vertical scroll zone
- ✅ Horizontal scroll zone
- ✅ Double-tap → double-click
- ✅ Separate taps after timeout

## Running Tests

### On Host Machine (Native Build)

Fastest iteration - no ESP32 hardware needed!

**Requirements:**
- CMake 3.14+
- C compiler (gcc, clang, MSVC)
- Works on Windows (MSYS2/MinGW), Linux, macOS

Unity test framework is downloaded automatically via CMake FetchContent.

```bash
# From project root
cd test
mkdir build && cd build
cmake ..        # Unity downloads automatically
cmake --build . # Cross-platform build command
./trackpad_tests
```

**Note:** Use `cmake --build .` instead of `make` for cross-platform compatibility (works with MSYS2 on Windows).

### On ESP32 (Unity Test App)

For integration testing with actual hardware:

```bash
# From project root
idf.py -D TEST_COMPONENTS='main' build flash monitor
```

## Test Infrastructure

### `trackpad_test_helper.h/c`
Provides:
- **Action Recorder (Spy Pattern)**: Records all actions generated by gesture processor
- **Test Context Builder (DSL)**: Readable test syntax
- **Input Event Helpers**: Easy creation of touch events with timing

### Example Test

```c
void test_tap_tap_drag(void)
{
    test_context_t *ctx = test_begin(320, 240, 40, 40);

    // First tap
    test_tap_at(ctx, 100, 100, 100);
    test_advance_time(ctx, 100);

    // Second tap + drag
    test_touch_down(ctx, 100, 100);
    test_advance_time(ctx, 50);
    test_touch_move(ctx, 130, 100);

    // Verify drag started with button held
    TEST_ASSERT_TRUE(recorder_has_action(ctx->recorder, TRACKPAD_ACTION_DRAG_START));
    const recorded_action_t *drag = recorder_find_first(ctx->recorder, TRACKPAD_ACTION_DRAG_START);
    TEST_ASSERT_EQUAL_UINT8(0x01, drag->buttons);

    test_end(ctx);
}
```

## Benefits

1. **Fast Feedback**: Tests run on host in milliseconds
2. **Deterministic**: Injected time means no flaky tests
3. **Edge Cases**: Easy to test exact boundary conditions
4. **Regression Prevention**: Changes to gesture logic immediately caught
5. **Documentation**: Tests serve as executable examples
6. **Refactoring Safety**: Can confidently improve code

## Adding New Tests

1. Add test function to `test_trackpad_gesture.c`
2. Use `test_context_t` for readable gesture simulation
3. Verify actions with `recorder_has_action()` and friends
4. Add to appropriate test suite in `main()`
